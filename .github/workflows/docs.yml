name: Generate API Documentation

on:
 push:
  branches:
   - main
  paths:
   - 'src/**/*.ts'
   - 'typedoc.json'
   - '.github/workflows/docs.yml'
 pull_request:
  branches:
   - main
  paths:
   - 'src/**/*.ts'
   - 'typedoc.json'

jobs:
 generate-docs:
  runs-on: ubuntu-latest

  steps:
   - name: Checkout code
     uses: actions/checkout@v4
     with:
      token: ${{ secrets.GITHUB_TOKEN }}
      fetch-depth: 0

   - name: Setup Node.js
     uses: actions/setup-node@v4
     with:
      node-version: '18'
      cache: 'npm'

   - name: Install dependencies
     run: npm ci

   - name: Generate API documentation
     run: npm run docs:api

   - name: Check for changes
     id: verify-changed-files
     run: |
      if [ -n "$(git status --porcelain)" ]; then
        echo "changed=true" >> $GITHUB_OUTPUT
      else
        echo "changed=false" >> $GITHUB_OUTPUT
      fi

   - name: Commit generated documentation
     if: steps.verify-changed-files.outputs.changed == 'true' && github.event_name == 'push'
     run: |
      git config --local user.email "action@github.com"
      git config --local user.name "GitHub Action"
      git add website/src/content/docs/developer/generated/
      git commit -m "Auto-generate API documentation from JSDoc comments [skip ci]" || exit 0
      git push

   - name: Comment on PR with documentation changes
     if: steps.verify-changed-files.outputs.changed == 'true' && github.event_name == 'pull_request'
     uses: actions/github-script@v7
     with:
      script: |
       github.rest.issues.createComment({
         issue_number: context.issue.number,
         owner: context.repo.owner,
         repo: context.repo.repo,
         body: 'ðŸ“– This PR includes changes to TypeScript source files. API documentation will be automatically updated when this is merged to main.'
       })

 deploy-docs:
  needs: generate-docs
  runs-on: ubuntu-latest
  if: github.ref == 'refs/heads/main'

  steps:
   - name: Checkout code
     uses: actions/checkout@v4
     with:
      fetch-depth: 0

   - name: Setup Node.js
     uses: actions/setup-node@v4
     with:
      node-version: '18'
      cache: 'npm'

   - name: Install dependencies
     run: npm ci

   - name: Install website dependencies
     run: cd website && npm ci

   - name: Generate API documentation
     run: npm run docs:api

   - name: Build website
     run: cd website && npm run build

   - name: Deploy to GitHub Pages
     uses: peaceiris/actions-gh-pages@v4
     with:
      github_token: ${{ secrets.GITHUB_TOKEN }}
      publish_dir: ./website/dist
      cname: fabr.yashjawale.dev
